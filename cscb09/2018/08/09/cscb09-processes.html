<!DOCTYPE html>
<html>
    <head>
        <title>CSCB09 Software Tools and Systems Programming - Processes - Jun Zheng</title>
        <link href="https://fonts.googleapis.com/css?family=Shanti" rel="stylesheet" />
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
        <link href="/assets/css/style.css?v=9a48274_20190108_152156" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.css" integrity="sha384-xNwWFq3SIvM4dq/1RUyWumk8nj/0KFg4TOnNcfzUU4X2gNn3WoRML69gO7waf3xh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-site-verification" content="3QG1yus3DT_i5qAC7SipJasW5cM13wwpNO1jesovSDY" />
        <link rel="shortcut icon" href="/assets/icons/favicon.png?v=9a48274_20190108_152156" />
    </head>
    <body>
<header>
    <div class="container">
        <h1>Jun Zheng <small>CSCB09 Software Tools and Systems Programming - Processes</small></h1>
    </div>
</header>

<nav class="navbar">
    <div class="container">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/experience.html">Experience</a></li>
            <li><a href="/research.html">Research</a></li>
            <li><a href="/education.html">Education</a></li>
            <li><a href="/posts.html">Posts</a></li>
            <li><a href="/contact.html">Contact</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <div class="js-toc"></div>
    <br/>
    
        <span class="post-tag">cscb09</span>
    
        <span class="post-tag">course-notes</span>
    
    <div class="post-content">
        <p>This article is mainly notes I have taken for CSCB09/CSC209 at UofT.</p>

<!--more-->

<h2 id="fork">fork</h2>

<p>A fork system call will create a child process that is a duplicate of the parent.</p>

<p><code class="highlighter-rouge">fork()</code> takes no arguments and returns a process ID.</p>

<p>To use fork, include <code class="highlighter-rouge">unistd.h</code>.</p>

<p>The return value of fork is different depends on the outcome:</p>

<ul>
  <li>On success
    <ul>
      <li>Return 0 if it is within child</li>
      <li>Return child‚Äôs PID if it is within parent</li>
    </ul>
  </li>
  <li>On failure
    <ul>
      <li>Return -1 to parent</li>
    </ul>
  </li>
</ul>

<p>Fork with loop example:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">child</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Child %d"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This program will have 8 processes in total, including the parent process.</p>

<h2 id="wait">wait</h2>

<p>Within parent process, you might want to wait for a child to terminate. You might also want to know the exit code for a child.</p>

<p>You can use <code class="highlighter-rouge">wait()</code> for that. It will block until one of the children terminates or there is no more child.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pid_t</span> <span class="n">wait</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
</code></pre></div></div>

<p>It returns the PID of the child, and sets the <code class="highlighter-rouge">status</code> as the child‚Äôs exit status.</p>

<h3 id="some-macros">Some Macros</h3>

<ul>
  <li><code class="highlighter-rouge">WIFEXITED</code> - If child terminated normally</li>
  <li><code class="highlighter-rouge">WEXITSTATUS</code> - Gives you the status</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Exited normally</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="zombie-processes">Zombie Processes</h2>

<p>When a child terminates, but its parent process is not waiting for it.</p>

<p>Then the child is kept around as a zombie until the parent collects its status using <code class="highlighter-rouge">wait</code>.</p>

<p>It will show up as <code class="highlighter-rouge">Z</code> in <code class="highlighter-rouge">ps</code>.</p>

<h2 id="orphan-processes">Orphan Processes</h2>

<p>If a parent terminates before the child, child becomes a orphan.</p>

<p>Orphans gets adopted by <code class="highlighter-rouge">init</code> process, which has PID of 1.</p>

<h2 id="waitpid">waitpid</h2>

<p>If you want to wait for a specific child, use waitpid</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pid_t</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">);</span>
</code></pre></div></div>

<p>If options is 0, it will block, just like wait.</p>

<p>However if it is WNOHANG, it will return 0, without blocking, you have to keep calling it to check.</p>

<h2 id="exec">exec</h2>

<p>Exec will <em>replace</em> the program being run by a different one.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="n">exec</span><span class="p">(</span><span class="s">"Y"</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</code></pre></div></div>

<p>The last line of the above program will NEVER run, unless there is an error.</p>

<p>Exec is a family of functions</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execl</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg0</span><span class="p">,</span> <span class="err">‚Ä¶</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">execv</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>
<span class="n">execlp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg0</span><span class="p">,</span> <span class="err">‚Ä¶</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">execvp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>
</code></pre></div></div>

<h3 id="shell-skeleton">Shell Skeleton</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
    <span class="n">print_prompt</span><span class="p">();</span>
    <span class="n">read_cmd</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fork</span><span class="p">()){</span>
        <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Exec</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="file-descriptors">File Descriptors</h2>

<p>FDs are handles to open files, they belong to processes.</p>

<p>FDs are preserved across fork and exec.</p>

<h2 id="initializing-unix">Initializing UNIX</h2>

<p>The only way to create new process is to fork, and only way to run new program is exec.</p>

<p>Therefore all processes have ancestor of pid 1.</p>


    </div>
</div>

<footer>
    <div class="container">
        <div class="build">[production] 9a48274_20190108_152156</div>
        Built and designed by myself üòù. GitHub: https://github.com/junthehacker/jackzh-com<br/>
        If you haven't done so, sign the <a href="http://manifesto.softwarecraftsmanship.org/#/en">Manifesto of Software Craftsmanship</a>.
        <a href="/opensource.html">Open Source</a>
    </div>
</footer>
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.js" integrity="sha384-UP7zD+aGyuDvxWQEDSRYcvoTxJSD82C6VvuEBktJZGo25CVhDstY9sCDHvyceo9L" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stickybits/3.5.8/stickybits.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/assets/js/app.js?v=9a48274_20190108_152156"></script>
</body>
</html>

<script>
    tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.js-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h2, h3, h4, h5',
        collapseDepth: 2
    });
    stickybits('.js-toc');
</script>